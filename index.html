<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <!-- Lucide icons will be replaced with simple text -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Identity Services for OAuth2 -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google Sheets Integration - Inline for GitHub Pages compatibility -->
    <script>
        // Google Sheets API Configuration
        const CONFIG = {
          // Your Google Sheet ID (hardcoded - users don't need to change this)
          SHEET_ID: '1SaP6Xl0Noi3RTBvuk5Rwthrh83_of4MlxFF6ZT3KHAc',
          
          // OAuth2 Configuration - Replace with your actual client ID
          OAUTH_CLIENT_ID: 'YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com',
          
          // The range in your sheet where meal data is stored
          // Expected format: Column A = Meal Name, Column B and beyond = Ingredients
          SHEET_RANGE: 'Sheet1!A:Z',
          
          // Google Sheets API endpoint
          API_BASE_URL: 'https://sheets.googleapis.com/v4/spreadsheets',
          
          // OAuth2 scopes for Google Sheets read/write access
          OAUTH_SCOPES: 'https://www.googleapis.com/auth/spreadsheets'
        };

        // Google Sheets API Service with OAuth2
        class GoogleSheetsService {
          constructor() {
            this.config = CONFIG;
            this.isLoading = false;
            this.isAuthenticated = false;
            this.accessToken = null;
            this.tokenClient = null;
          }

          /**
           * Initialize OAuth2 token client
           */
          async initializeOAuth() {
            if (!this.config.OAUTH_CLIENT_ID || this.config.OAUTH_CLIENT_ID === 'YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com') {
              throw new Error('Please configure your OAuth2 client ID in the CONFIG section');
            }

            return new Promise((resolve, reject) => {
              if (typeof google === 'undefined' || !google.accounts) {
                reject(new Error('Google Identity Services not loaded'));
                return;
              }

              this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: this.config.OAUTH_CLIENT_ID,
                scope: this.config.OAUTH_SCOPES,
                callback: (response) => {
                  if (response.error) {
                    reject(new Error(response.error));
                    return;
                  }
                  this.accessToken = response.access_token;
                  this.isAuthenticated = true;
                  resolve(response);
                },
              });
              
              resolve(this.tokenClient);
            });
          }

          /**
           * Sign in with Google OAuth2
           */
          async signIn() {
            try {
              if (!this.tokenClient) {
                await this.initializeOAuth();
              }
              
              this.tokenClient.requestAccessToken();
            } catch (error) {
              console.error('OAuth sign-in error:', error);
              throw error;
            }
          }

          /**
           * Sign out and revoke access token
           */
          async signOut() {
            if (this.accessToken) {
              google.accounts.oauth2.revoke(this.accessToken);
            }
            this.accessToken = null;
            this.isAuthenticated = false;
          }

          /**
           * Make authenticated request to Google Sheets API
           */
          async makeAuthenticatedRequest(url, options = {}) {
            if (!this.isAuthenticated || !this.accessToken) {
              throw new Error('Not authenticated. Please sign in first.');
            }

            const headers = {
              'Authorization': `Bearer ${this.accessToken}`,
              'Content-Type': 'application/json',
              ...options.headers
            };

            const response = await fetch(url, {
              ...options,
              headers
            });

            if (!response.ok) {
              if (response.status === 401) {
                // Token expired, user needs to re-authenticate
                this.isAuthenticated = false;
                this.accessToken = null;
                throw new Error('Authentication expired. Please sign in again.');
              } else if (response.status === 403) {
                throw new Error('Permission denied. Please ensure you have granted access to Google Sheets.');
              } else {
                const errorText = await response.text();
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
              }
            }

            return response;
          }

          /**
           * Read data from Google Sheets
           * @returns {Promise<Array>} Array of meal objects
           */
          async readMeals() {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            this.isLoading = true;
            
            try {
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.SHEET_RANGE}`;
              
              const response = await this.makeAuthenticatedRequest(url);
              const data = await response.json();
              
              if (!data.values || data.values.length === 0) {
                return [];
              }

              // Convert sheet data to meal objects
              const meals = data.values.slice(1).map(row => {
                if (!row[0] || row[0].trim() === '') return null;
                
                return {
                  name: row[0].trim(),
                  ingredients: row.slice(1).filter(ingredient => 
                    ingredient && ingredient.trim() !== ''
                  ).map(ingredient => ingredient.trim())
                };
              }).filter(meal => meal !== null);

              return meals;
            } catch (error) {
              console.error('Error reading from Google Sheets:', error);
              throw error;
            } finally {
              this.isLoading = false;
            }
          }

          /**
           * Write a new meal to Google Sheets
           * @param {Object} meal - Meal object with name and ingredients
           * @returns {Promise<boolean>} Success status
           */
          async addMeal(meal) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // First, get current data to find the next empty row
              const currentMeals = await this.readMeals();
              const nextRow = currentMeals.length + 2; // +2 because we start from row 2 (after header)
              
              const rowData = [meal.name, ...meal.ingredients];
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${nextRow}:append?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'POST',
                body: JSON.stringify({
                  values: [rowData]
                })
              });

              return true;
            } catch (error) {
              console.error('Error adding meal to Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Update an existing meal in Google Sheets
           * @param {number} rowIndex - The row index (0-based) of the meal to update
           * @param {Object} meal - Updated meal object
           * @returns {Promise<boolean>} Success status
           */
          async updateMeal(rowIndex, meal) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              const sheetRow = rowIndex + 2; // +2 because we start from row 2 (after header)
              const rowData = [meal.name, ...meal.ingredients];
              
              // Clear the row first by getting the current range
              const clearUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${sheetRow}:Z${sheetRow}:clear`;
              
              await this.makeAuthenticatedRequest(clearUrl, {
                method: 'POST'
              });

              // Now update with new data
              const updateUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${sheetRow}?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(updateUrl, {
                method: 'PUT',
                body: JSON.stringify({
                  values: [rowData]
                })
              });

              return true;
            } catch (error) {
              console.error('Error updating meal in Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Delete a meal from Google Sheets
           * @param {number} rowIndex - The row index (0-based) of the meal to delete
           * @returns {Promise<boolean>} Success status
           */
          async deleteMeal(rowIndex) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              const sheetRow = rowIndex + 2; // +2 because we start from row 2 (after header)
              
              // Clear the entire row
              const clearUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${sheetRow}:Z${sheetRow}:clear`;
              
              await this.makeAuthenticatedRequest(clearUrl, {
                method: 'POST'
              });

              return true;
            } catch (error) {
              console.error('Error deleting meal from Google Sheets:', error);
              throw error;
            }
          }
        }

        // Make it globally available
        window.GoogleSheetsService = GoogleSheetsService;
        window.CONFIG = CONFIG;
    </script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }
        
        code {
            font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
                monospace;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;
        // Simple icon replacements
        const Shuffle = () => "🎲";
        const ShoppingCart = () => "🛒";
        const Plus = () => "➕";
        const X = () => "❌";
        const RefreshCw = () => "🔄";
        const Save = () => "💾";
        const Edit = () => "✏️";

        const MealPlanner = () => {
          // Initialize Google Sheets service
          const [sheetsService] = useState(() => new GoogleSheetsService());
          const [isLoadingSheets, setIsLoadingSheets] = useState(false);
          const [sheetsError, setSheetsError] = useState(null);
          const [useLocalData, setUseLocalData] = useState(true);
          const [isSignedIn, setIsSignedIn] = useState(false);
          const [userInfo, setUserInfo] = useState(null);

          // Your historic meals (fallback data)
          const sampleMeals = [
            { name: "Ahi tuna salad", ingredients: [] },
            { name: "Alfredo chicken", ingredients: [] },
            { name: "Alfredo meatballs", ingredients: [] },
            { name: "Baby back ribs", ingredients: [] },
            { name: "Bacon Wrapped chicken", ingredients: [] },
            { name: "Bacon Wrapped pork loin", ingredients: [] },
            { name: "Baked feta pasta", ingredients: [] },
            { name: "Baked Potato", ingredients: [] },
            { name: "Baked ziti", ingredients: [] },
            { name: "Bbq kielbasa", ingredients: [] },
            { name: "Beef and broccoli", ingredients: [] },
            { name: "Beer brats", ingredients: [] },
            { name: "Biscuits and Gravy", ingredients: [] },
            { name: "Blackened Salmon", ingredients: [] },
            { name: "Brats", ingredients: [] },
            { name: "Breakfast Skillet", ingredients: [] },
            { name: "Brisket", ingredients: [] },
            { name: "Bulgogi Sauce Meatballs", ingredients: [] },
            { name: "Burger bowls", ingredients: [] },
            { name: "Burrito bowls", ingredients: [] },
            { name: "Burritos", ingredients: [] },
            { name: "Butter chicken", ingredients: [] },
            { name: "Cajun shrimp alfredo", ingredients: [] },
            { name: "Chef Salad", ingredients: [] },
            { name: "Chicken and shrimp tacos", ingredients: [] },
            { name: "Chicken bacon carbonara", ingredients: [] },
            { name: "Chicken Caesar Salad", ingredients: [] },
            { name: "Chicken cordon bleu", ingredients: [] },
            { name: "Chicken Fried steak", ingredients: [] },
            { name: "Chicken Marinara", ingredients: [] },
            { name: "Chicken Noodle Soup", ingredients: [] },
            { name: "Chicken Quesadilla", ingredients: [] },
            { name: "Chicken Sandwiches", ingredients: [] },
            { name: "Chicken taco", ingredients: [] },
            { name: "Chicken teriyaki", ingredients: [] },
            { name: "Chicken tort alfredo", ingredients: [] },
            { name: "Chili - Traditional", ingredients: [] },
            { name: "Chili verde", ingredients: [] },
            { name: "Chuck Pot Roast", ingredients: [] },
            { name: "Crab legs", ingredients: [] },
            { name: "Creamy Tostadas", ingredients: [] },
            { name: "Crispy Franks redhot chicken (hello)", ingredients: [] },
            { name: "Fajita bowl", ingredients: [] },
            { name: "Fajitas", ingredients: [] },
            { name: "Flautas (hello)", ingredients: [] },
            { name: "French Dip", ingredients: [] },
            { name: "General Tso", ingredients: [] },
            { name: "Grilled Chicken", ingredients: [] },
            { name: "Grilled Chicken thighs", ingredients: [] },
            { name: "Grilled Sammies", ingredients: [] },
            { name: "Hamburgers", ingredients: [] },
            { name: "Hibachi filet mignon", ingredients: [] },
            { name: "Hibachi Stir Fry", ingredients: [] },
            { name: "Honey garlic pork chops", ingredients: [] },
            { name: "Honey sriracha chicken", ingredients: [] },
            { name: "Hot Dogs", ingredients: [] },
            { name: "Italian Chicken pasta", ingredients: [] },
            { name: "Kabobs", ingredients: [] },
            { name: "Kielbasa in vodka sauce", ingredients: [] },
            { name: "Kung Pao chicken", ingredients: [] },
            { name: "Lasagna", ingredients: [] },
            { name: "Lobster", ingredients: [] },
            { name: "Meat Loaf", ingredients: [] },
            { name: "Meatballs", ingredients: [] },
            { name: "Minestrone Soup", ingredients: [] },
            { name: "Mongolian beef", ingredients: [] },
            { name: "Navajo Tacos", ingredients: [] },
            { name: "Orange Chicken", ingredients: [] },
            { name: "Pepper steak", ingredients: [] },
            { name: "Pesto Chicken", ingredients: [] },
            { name: "Philly cheese steaks", ingredients: [] },
            { name: "Pizza", ingredients: [] },
            { name: "Poke", ingredients: [] },
            { name: "Pork bulgogi bowls (hello)", ingredients: [] },
            { name: "Pork Flautas", ingredients: [] },
            { name: "Pork Tenderloin", ingredients: [] },
            { name: "Pot Pie", ingredients: [] },
            { name: "Pot roast", ingredients: [] },
            { name: "Potato Soup", ingredients: [] },
            { name: "pulled pork", ingredients: [] },
            { name: "pulled pork pitas", ingredients: [] },
            { name: "Red beans and rice", ingredients: [] },
            { name: "Rib eye steaks", ingredients: [] },
            { name: "Ribs", ingredients: [] },
            { name: "Salmon", ingredients: [] },
            { name: "Shake and Bake", ingredients: [] },
            { name: "Shrimp burrito", ingredients: [] },
            { name: "Shrimp scampi", ingredients: [] },
            { name: "Sloppy joes", ingredients: [] },
            { name: "Soup And Sandwiches", ingredients: [] },
            { name: "South west pasta", ingredients: [] },
            { name: "Spaghetti", ingredients: [] },
            { name: "Spicy Kielbasa pasta", ingredients: [] },
            { name: "Steak & lobster", ingredients: [] },
            { name: "Steak & potatoes", ingredients: [] },
            { name: "Steak burgers", ingredients: [] },
            { name: "Stevie Feel good", ingredients: [] },
            { name: "Stew", ingredients: [] },
            { name: "Stir fry", ingredients: [] },
            { name: "Stuffed Peppers", ingredients: [] },
            { name: "Stuffed shells", ingredients: [] },
            { name: "Sweet and sour chicken", ingredients: [] },
            { name: "Sweet chili chicken (every plate)", ingredients: [] },
            { name: "Sweet fire chicken", ingredients: [] },
            { name: "Sweet pork", ingredients: [] },
            { name: "Sweet pork burritos", ingredients: [] },
            { name: "Szechuan beef noodles (hello)", ingredients: [] },
            { name: "Taco Mac", ingredients: [] },
            { name: "Taco Salad", ingredients: [] },
            { name: "Taco soup", ingredients: [] },
            { name: "Tamale pie", ingredients: [] },
            { name: "Tamales", ingredients: [] },
            { name: "Tater Tot Casserole", ingredients: [] },
            { name: "Thai coconut pork meatballs (Hello)", ingredients: [] },
            { name: "Thick pork chops", ingredients: [] },
            { name: "Thin pork chops", ingredients: [] },
            { name: "Tortellini soup", ingredients: [] },
            { name: "Tots and gravy", ingredients: [] },
            { name: "Tri-Tip", ingredients: [] },
            { name: "Tuscany tort", ingredients: [] },
            { name: "Waffles", ingredients: [] },
            { name: "Walking tacos", ingredients: [] },
            { name: "White Chicken Chilli", ingredients: [] },
            { name: "White gravy pork chops", ingredients: [] },
            { name: "Whole roasted chicken", ingredients: [] },
            { name: "Chicken Bacon ranch pasta", ingredients: [] }
          ];

          const [mealCount, setMealCount] = useState(7);
          const [selectedMeals, setSelectedMeals] = useState([]);
          const [showGroceryList, setShowGroceryList] = useState(false);
          const [allMeals, setAllMeals] = useState(sampleMeals);
          const [showAddMeal, setShowAddMeal] = useState(false);
          const [newMealName, setNewMealName] = useState('');
          const [newMealIngredients, setNewMealIngredients] = useState(['']);
          const [editingMealIndex, setEditingMealIndex] = useState(-1);
          const [showMealList, setShowMealList] = useState(false);

          // Sign in with Google OAuth2
          const signInWithGoogle = async () => {
            setIsLoadingSheets(true);
            setSheetsError(null);
            
            try {
              await sheetsService.signIn();
              setIsSignedIn(true);
              
              // Load meals after successful sign-in
              if (!useLocalData) {
                await loadMealsFromSheets();
              }
            } catch (error) {
              console.error('Failed to sign in:', error);
              setSheetsError(error.message);
              setIsSignedIn(false);
            } finally {
              setIsLoadingSheets(false);
            }
          };

          // Sign out from Google OAuth2
          const signOutFromGoogle = async () => {
            try {
              await sheetsService.signOut();
              setIsSignedIn(false);
              setUserInfo(null);
              
              // Switch back to local data
              if (!useLocalData) {
                setUseLocalData(true);
                setAllMeals(sampleMeals);
              }
            } catch (error) {
              console.error('Failed to sign out:', error);
              setSheetsError(error.message);
            }
          };

          // Load meals from Google Sheets
          const loadMealsFromSheets = async () => {
            if (useLocalData || !isSignedIn) return;
            
            setIsLoadingSheets(true);
            setSheetsError(null);
            
            try {
              const meals = await sheetsService.readMeals();
              setAllMeals(meals.length > 0 ? meals : sampleMeals);
              console.log('Loaded meals from Google Sheets:', meals.length);
            } catch (error) {
              console.error('Failed to load from Google Sheets:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
              setAllMeals(sampleMeals); // Fallback to local data
            } finally {
              setIsLoadingSheets(false);
            }
          };

          // Save meal to Google Sheets
          const saveMealToSheets = async (meal, isUpdate = false, originalIndex = -1) => {
            if (useLocalData || !isSignedIn) return true;
            
            try {
              if (isUpdate) {
                await sheetsService.updateMeal(originalIndex, meal);
              } else {
                await sheetsService.addMeal(meal);
              }
              return true;
            } catch (error) {
              console.error('Failed to save to Google Sheets:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
              return false;
            }
          };

          // Initialize OAuth2 when component mounts
          const initializeOAuth = async () => {
            try {
              await sheetsService.initializeOAuth();
            } catch (error) {
              console.error('Failed to initialize OAuth:', error);
              setSheetsError(error.message);
            }
          };

          // Toggle between local and Google Sheets data
          const toggleDataSource = async () => {
            const newUseLocalData = !useLocalData;
            setUseLocalData(newUseLocalData);
            
            if (!newUseLocalData) {
              // Switching to Google Sheets - need to sign in
              if (!isSignedIn) {
                try {
                  await signInWithGoogle();
                } catch (error) {
                  // If sign-in fails, revert back to local data
                  setUseLocalData(true);
                  setAllMeals(sampleMeals);
                }
              } else {
                // Already signed in, just load data
                await loadMealsFromSheets();
              }
            } else {
              // Switching to local data
              setAllMeals(sampleMeals);
              setSheetsError(null);
            }
          };

          // Add a new ingredient input field
          const addIngredientField = () => {
            setNewMealIngredients([...newMealIngredients, '']);
          };

          // Remove an ingredient input field
          const removeIngredientField = (index) => {
            const filtered = newMealIngredients.filter((_, i) => i !== index);
            setNewMealIngredients(filtered.length > 0 ? filtered : ['']);
          };

          // Update ingredient at specific index
          const updateIngredient = (index, value) => {
            const updated = [...newMealIngredients];
            updated[index] = value;
            setNewMealIngredients(updated);
          };

          // Start editing a meal
          const startEditMeal = (index) => {
            const meal = allMeals[index];
            setNewMealName(meal.name);
            setNewMealIngredients(meal.ingredients.length > 0 ? meal.ingredients : ['']);
            setEditingMealIndex(index);
            setShowAddMeal(true);
          };

          // Save new meal or update existing
          const saveNewMeal = async () => {
            if (newMealName.trim()) {
              const filteredIngredients = newMealIngredients.filter(ing => ing.trim() !== '');
              const mealData = {
                name: newMealName.trim(),
                ingredients: filteredIngredients
              };
              
              if (editingMealIndex >= 0) {
                // Update existing meal
                const updatedMeals = [...allMeals];
                updatedMeals[editingMealIndex] = mealData;
                
                // Try to save to Google Sheets
                const success = await saveMealToSheets(mealData, true, editingMealIndex);
                if (success || useLocalData) {
                  setAllMeals(updatedMeals);
                  
                  // Update selected meals if the edited meal is currently selected
                  setSelectedMeals(prev => 
                    prev.map(meal => 
                      meal.name === allMeals[editingMealIndex].name ? mealData : meal
                    )
                  );
                }
              } else {
                // Add new meal
                const success = await saveMealToSheets(mealData, false);
                if (success || useLocalData) {
                  setAllMeals([...allMeals, mealData]);
                }
              }
              
              resetMealForm();
            }
          };

          // Reset the meal form
          const resetMealForm = () => {
            setNewMealName('');
            setNewMealIngredients(['']);
            setShowAddMeal(false);
            setEditingMealIndex(-1);
          };

          // Cancel adding/editing meal
          const cancelAddMeal = () => {
            resetMealForm();
          };

          // Generate random meals
          const generateRandomMeals = () => {
            const shuffled = [...allMeals].sort(() => 0.5 - Math.random());
            setSelectedMeals(shuffled.slice(0, mealCount));
            setShowGroceryList(false);
          };

          // Replace a specific meal
          const replaceMeal = (index) => {
            const usedMealNames = selectedMeals.map(meal => meal.name);
            const availableMeals = allMeals.filter(meal => !usedMealNames.includes(meal.name));
            
            if (availableMeals.length > 0) {
              const randomMeal = availableMeals[Math.floor(Math.random() * availableMeals.length)];
              const newMeals = [...selectedMeals];
              newMeals[index] = randomMeal;
              setSelectedMeals(newMeals);
            }
          };

          // Generate grocery list
          const generateGroceryList = () => {
            const allIngredients = selectedMeals.flatMap(meal => meal.ingredients);
            const ingredientCount = {};
            
            allIngredients.forEach(ingredient => {
              ingredientCount[ingredient] = (ingredientCount[ingredient] || 0) + 1;
            });
            
            return Object.entries(ingredientCount).sort();
          };

          // Auto-generate meals when meal count changes
          useEffect(() => {
            if (mealCount > 0) {
              generateRandomMeals();
            }
          }, [mealCount]);

          // Initialize OAuth2 on component mount
          useEffect(() => {
            initializeOAuth();
          }, []);

          return (
            <div className="max-w-4xl mx-auto p-6 bg-white">
              <h1 className="text-3xl font-bold text-gray-800 mb-8 text-center">Meal Planner</h1>
              
              {/* Data Source Toggle */}
              <div className="bg-yellow-50 p-6 rounded-lg mb-6 border border-yellow-200">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h2 className="text-lg font-medium text-gray-800">Data Source</h2>
                    <p className="text-sm text-gray-600">
                      Choose between local data or Google Sheets integration with OAuth2
                    </p>
                  </div>
                  <div className="flex items-center space-x-4">
                    <label className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={!useLocalData}
                        onChange={toggleDataSource}
                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      />
                      <span className="text-sm font-medium text-gray-700">
                        Use Google Sheets
                      </span>
                    </label>
                  </div>
                </div>
                
                {/* OAuth2 Authentication */}
                {!useLocalData && (
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Google Authentication
                    </label>
                    
                    {!isSignedIn ? (
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={signInWithGoogle}
                          disabled={isLoadingSheets}
                          className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 transition-colors"
                        >
                          <span>🔐</span>
                          <span>{isLoadingSheets ? 'Signing in...' : 'Sign in with Google'}</span>
                        </button>
                        <p className="text-sm text-gray-600">
                          Sign in to read and write meal data to Google Sheets
                        </p>
                      </div>
                    ) : (
                      <div className="flex items-center justify-between bg-green-50 p-3 rounded-lg border border-green-200">
                        <div className="flex items-center space-x-2">
                          <span className="text-green-600">✓</span>
                          <span className="text-sm text-green-800 font-medium">
                            Signed in to Google Sheets
                          </span>
                        </div>
                        <div className="flex items-center space-x-2">
                          <button
                            onClick={loadMealsFromSheets}
                            disabled={isLoadingSheets}
                            className="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 transition-colors text-sm"
                          >
                            {isLoadingSheets ? 'Loading...' : 'Refresh Data'}
                          </button>
                          <button
                            onClick={signOutFromGoogle}
                            className="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm"
                          >
                            Sign Out
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                )}
                
                {/* Error Message */}
                {sheetsError && (
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 className="font-medium text-red-800 mb-2">Google Sheets Error</h3>
                    <p className="text-sm text-red-700 mb-3">{sheetsError}</p>
                    <p className="text-xs text-red-600">
                      {sheetsError.includes('Authentication expired') ? 
                        'Please sign in again to continue using Google Sheets.' :
                        'Using local data as fallback. Please check your configuration and try again.'
                      }
                    </p>
                  </div>
                )}
                
                {/* Status */}
                <div className="text-sm text-gray-600">
                  <strong>Status:</strong> {useLocalData ? 'Using local data' : 
                    isLoadingSheets ? 'Loading from Google Sheets...' : 
                    sheetsError ? 'Using local data (Google Sheets error)' : 
                    isSignedIn ? 'Connected to Google Sheets' : 'Sign in to connect to Google Sheets'}
                </div>
              </div>
              
              {/* Add New Meal Section */}
              <div className="bg-purple-50 p-6 rounded-lg mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-medium text-gray-800">Meal Database</h2>
                  <div className="flex items-center space-x-4">
                    <span className="text-sm text-gray-600">
                      Total meals: {allMeals.length}
                    </span>
                    <button
                      onClick={() => setShowMealList(!showMealList)}
                      className="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"
                    >
                      {showMealList ? 'Hide' : 'View'} All Meals
                    </button>
                    {!showAddMeal && (
                      <button
                        onClick={() => {
                          setEditingMealIndex(-1);
                          setShowAddMeal(true);
                        }}
                        className="flex items-center space-x-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
                      >
                        <span>➕</span>
                        <span>Add New Meal</span>
                      </button>
                    )}
                  </div>
                </div>

                {/* Meal List for Editing */}
                {showMealList && !showAddMeal && (
                  <div className="bg-white p-4 rounded-lg border-2 border-purple-200 mb-4">
                    <h3 className="font-medium text-gray-800 mb-4">All Meals</h3>
                    <div className="max-h-64 overflow-y-auto space-y-2">
                      {allMeals.map((meal, index) => (
                        <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex-1">
                            <h4 className="font-medium text-gray-800">{meal.name}</h4>
                            <p className="text-sm text-gray-600">
                              {meal.ingredients && meal.ingredients.length > 0 
                                ? `${meal.ingredients.length} ingredients`
                                : 'No ingredients'
                              }
                            </p>
                          </div>
                          <button
                            onClick={() => startEditMeal(index)}
                            className="flex items-center space-x-1 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                          >
                            <span>✏️</span>
                            <span>Edit</span>
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {showAddMeal && (
                  <div className="bg-white p-4 rounded-lg border-2 border-purple-200">
                    <h3 className="font-medium text-gray-800 mb-4">
                      {editingMealIndex >= 0 ? 'Edit Meal' : 'Add New Meal'}
                    </h3>
                    
                    {/* Meal Name Input */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Meal Name
                      </label>
                      <input
                        type="text"
                        value={newMealName}
                        onChange={(e) => setNewMealName(e.target.value)}
                        placeholder="Enter meal name..."
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                    </div>

                    {/* Ingredients Input */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Ingredients
                      </label>
                      <div className="space-y-2">
                        {newMealIngredients.map((ingredient, index) => (
                          <div key={index} className="flex items-center space-x-2">
                            <input
                              type="text"
                              value={ingredient}
                              onChange={(e) => updateIngredient(index, e.target.value)}
                              placeholder="Enter ingredient..."
                              className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            {newMealIngredients.length > 1 && (
                              <button
                                onClick={() => removeIngredientField(index)}
                                className="p-2 text-red-500 hover:bg-red-50 rounded-md"
                              >
                                <span>❌</span>
                              </button>
                            )}
                          </div>
                        ))}
                        <button
                          onClick={addIngredientField}
                          className="flex items-center space-x-1 px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors"
                        >
                          <span>➕</span>
                          <span>Add Ingredient</span>
                        </button>
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex items-center space-x-3">
                      <button
                        onClick={saveNewMeal}
                        disabled={!newMealName.trim()}
                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                      >
                        <span>💾</span>
                        <span>{editingMealIndex >= 0 ? 'Update Meal' : 'Save Meal'}</span>
                      </button>
                      <button
                        onClick={cancelAddMeal}
                        className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                )}
              </div>

              {/* Meal Count Selector */}
              <div className="bg-blue-50 p-6 rounded-lg mb-6">
                <label className="block text-lg font-medium text-gray-700 mb-3">
                  How many meals do you want to plan?
                </label>
                <div className="flex items-center space-x-4">
                  <input
                    type="number"
                    min="1"
                    max="14"
                    value={mealCount}
                    onChange={(e) => setMealCount(parseInt(e.target.value) || 1)}
                    className="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <button
                    onClick={generateRandomMeals}
                    className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                  >
                    <span>🎲</span>
                    <span>Generate New Plan</span>
                  </button>
                </div>
              </div>

              {/* Meal List */}
              {selectedMeals.length > 0 && (
                <div className="mb-6">
                  <h2 className="text-xl font-semibold text-gray-800 mb-4">Your Meal Plan</h2>
                  <div className="space-y-3">
                    {selectedMeals.map((meal, index) => (
                      <div key={index} className="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                        <div>
                          <h3 className="font-medium text-gray-800">{meal.name}</h3>
                          <p className="text-sm text-gray-600">
                            {meal.ingredients && meal.ingredients.length > 0 
                              ? (meal.ingredients.slice(0, 4).join(', ') + 
                                 (meal.ingredients.length > 4 ? ` + ${meal.ingredients.length - 4} more` : ''))
                              : 'No ingredients listed'
                            }
                          </p>
                        </div>
                        <button
                          onClick={() => replaceMeal(index)}
                          className="flex items-center space-x-1 px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors"
                        >
                          <span>🔄</span>
                          <span>Replace</span>
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Generate Grocery List Button */}
              {selectedMeals.length > 0 && (
                <div className="mb-6">
                  {selectedMeals.some(meal => meal.ingredients && meal.ingredients.length > 0) ? (
                    <button
                      onClick={() => setShowGroceryList(!showGroceryList)}
                      className="flex items-center space-x-2 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                    >
                      <span>🛒</span>
                      <span>{showGroceryList ? 'Hide' : 'Show'} Grocery List</span>
                    </button>
                  ) : (
                    <div className="bg-yellow-50 p-4 rounded-lg">
                      <p className="text-sm text-gray-700">
                        <strong>Note:</strong> Add ingredients to your meals to generate a grocery list!
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Grocery List */}
              {showGroceryList && selectedMeals.length > 0 && (
                <div className="bg-green-50 p-6 rounded-lg">
                  <h2 className="text-xl font-semibold text-gray-800 mb-4">Grocery List</h2>
                  {generateGroceryList().length > 0 ? (
                    <>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                        {generateGroceryList().map(([ingredient, count]) => (
                          <div key={ingredient} className="flex items-center justify-between bg-white p-2 rounded border">
                            <span className="text-gray-700 capitalize">{ingredient}</span>
                            {count > 1 && (
                              <span className="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full">
                                x{count}
                              </span>
                            )}
                          </div>
                        ))}
                      </div>
                      <div className="mt-4 text-sm text-gray-600">
                        Total items: {generateGroceryList().length}
                      </div>
                    </>
                  ) : (
                    <p className="text-gray-600">No ingredients found in selected meals. Add ingredients to meals to generate a grocery list!</p>
                  )}
                </div>
              )}

              {/* Instructions */}
              <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                <h3 className="font-medium text-gray-800 mb-2">Meal Planner with Google Sheets OAuth2 Integration!</h3>
                <p className="text-sm text-gray-600 mb-2">
                  {useLocalData ? 
                    'Currently using local data with 113 historic meals. Enable Google Sheets integration above and sign in with your Google account to sync with the spreadsheet.' :
                    isSignedIn ? 
                      'Google Sheets integration is enabled and connected. Your meals will be saved to and loaded from the Google Sheet with full read/write access.' :
                      'Google Sheets integration is enabled. Sign in with your Google account above to connect with full access.'
                  }
                </p>
                <p className="text-sm text-gray-600">
                  <strong>Setup:</strong> Configure OAuth2 in Google Cloud Console and update the OAUTH_CLIENT_ID in the code. OAuth2 provides secure authentication and full read/write access to your Google Sheets.
                </p>
              </div>
            </div>
          );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<MealPlanner />);
    </script>
</body>
</html>
