<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <!-- Lucide icons will be replaced with simple text -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Identity Services for OAuth2 -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Google Sheets Integration - Inline for GitHub Pages compatibility -->
    <script>
        // Google Sheets API Configuration
        const CONFIG = {
          // Your Google Sheet ID (hardcoded - users don't need to change this)
          SHEET_ID: '1SaP6Xl0Noi3RTBvuk5Rwthrh83_of4MlxFF6ZT3KHAc',
          
          // OAuth2 Configuration - Replace with your actual client ID
          OAUTH_CLIENT_ID: '1045588807906-et424ct3a4pghp6nukg18r4g0g0o5fh4.apps.googleusercontent.com',
          
          // The range in your sheet where meal data is stored
          // Expected format: Column A = Meal Name, Column B and beyond = Ingredients
          SHEET_RANGE: 'Sheet1!A:Z',
          
          // Meal Plans Sheet Configuration
          MEAL_PLANS_SHEET: 'MealPlans',
          MEAL_PLANS_RANGE: 'MealPlans!A:Z',
          
          // Ingredients Sheet Configuration
          INGREDIENTS_SHEET: 'Ingredients',
          INGREDIENTS_RANGE: 'Ingredients!A:Z',
          
          // Grocery Lists Sheet Configuration
          GROCERY_LISTS_SHEET: 'GroceryLists',
          GROCERY_LISTS_RANGE: 'GroceryLists!A:Z',
          
          // Google Sheets API endpoint
          API_BASE_URL: 'https://sheets.googleapis.com/v4/spreadsheets',
          
          // OAuth2 scopes for Google Sheets read/write access
          OAUTH_SCOPES: 'https://www.googleapis.com/auth/spreadsheets'
        };

        // Google Sheets API Service with OAuth2
        class GoogleSheetsService {
          constructor() {
            this.config = CONFIG;
            this.isLoading = false;
            this.isAuthenticated = false;
            this.accessToken = null;
            this.tokenClient = null;
          }

          /**
           * Initialize OAuth2 token client
           */
          async initializeOAuth() {
            if (!this.config.OAUTH_CLIENT_ID || this.config.OAUTH_CLIENT_ID === 'YOUR_GOOGLE_OAUTH_CLIENT_ID.apps.googleusercontent.com') {
              throw new Error('Please configure your OAuth2 client ID in the CONFIG section');
            }

            return new Promise((resolve, reject) => {
              if (typeof google === 'undefined' || !google.accounts) {
                reject(new Error('Google Identity Services not loaded'));
                return;
              }

              this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: this.config.OAUTH_CLIENT_ID,
                scope: this.config.OAUTH_SCOPES,
                callback: (response) => {
                  if (response.error) {
                    reject(new Error(response.error));
                    return;
                  }
                  this.accessToken = response.access_token;
                  this.isAuthenticated = true;
                  resolve(response);
                },
              });
              
              resolve(this.tokenClient);
            });
          }

          /**
           * Sign in with Google OAuth2
           */
          async signIn() {
            try {
              if (!this.tokenClient) {
                await this.initializeOAuth();
              }
              
              this.tokenClient.requestAccessToken();
            } catch (error) {
              console.error('OAuth sign-in error:', error);
              throw error;
            }
          }

          /**
           * Sign out and revoke access token
           */
          async signOut() {
            if (this.accessToken) {
              google.accounts.oauth2.revoke(this.accessToken);
            }
            this.accessToken = null;
            this.isAuthenticated = false;
          }

          /**
           * Make authenticated request to Google Sheets API
           */
          async makeAuthenticatedRequest(url, options = {}) {
            if (!this.isAuthenticated || !this.accessToken) {
              throw new Error('Not authenticated. Please sign in first.');
            }

            const headers = {
              'Authorization': `Bearer ${this.accessToken}`,
              'Content-Type': 'application/json',
              ...options.headers
            };

            const response = await fetch(url, {
              ...options,
              headers
            });

            if (!response.ok) {
              if (response.status === 401) {
                // Token expired, user needs to re-authenticate
                this.isAuthenticated = false;
                this.accessToken = null;
                throw new Error('Authentication expired. Please sign in again.');
              } else if (response.status === 403) {
                throw new Error('Permission denied. Please ensure you have granted access to Google Sheets.');
              } else {
                const errorText = await response.text();
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorText}`);
              }
            }

            return response;
          }

          /**
           * Read data from Google Sheets
           * @returns {Promise<Array>} Array of meal objects
           */
          async readMeals() {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            this.isLoading = true;
            
            try {
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.SHEET_RANGE}`;
              
              const response = await this.makeAuthenticatedRequest(url);
              const data = await response.json();
              
              if (!data.values || data.values.length === 0) {
                return [];
              }

              // Convert sheet data to meal objects
              const meals = data.values.slice(1).map(row => {
                if (!row[0] || row[0].trim() === '') return null;
                
                return {
                  name: row[0].trim(),
                  ingredients: row.slice(1).filter(ingredient => 
                    ingredient && ingredient.trim() !== ''
                  ).map(ingredient => ingredient.trim())
                };
              }).filter(meal => meal !== null);

              return meals;
            } catch (error) {
              console.error('Error reading from Google Sheets:', error);
              throw error;
            } finally {
              this.isLoading = false;
            }
          }

          /**
           * Write a new meal to Google Sheets
           * @param {Object} meal - Meal object with name and ingredients
           * @returns {Promise<boolean>} Success status
           */
          async addMeal(meal) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // First, get current data to find the next empty row
              const currentMeals = await this.readMeals();
              const nextRow = currentMeals.length + 2; // +2 because we start from row 2 (after header)
              
              const rowData = [meal.name, ...meal.ingredients];
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${nextRow}:append?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'POST',
                body: JSON.stringify({
                  values: [rowData]
                })
              });

              return true;
            } catch (error) {
              console.error('Error adding meal to Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Update an existing meal in Google Sheets
           * @param {number} rowIndex - The row index (0-based) of the meal to update
           * @param {Object} meal - Updated meal object
           * @returns {Promise<boolean>} Success status
           */
          async updateMeal(rowIndex, meal) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              const sheetRow = rowIndex + 2; // +2 because we start from row 2 (after header)
              const rowData = [meal.name, ...meal.ingredients];
              
              // Clear the row first by getting the current range
              const clearUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${sheetRow}:Z${sheetRow}:clear`;
              
              await this.makeAuthenticatedRequest(clearUrl, {
                method: 'POST'
              });

              // Now update with new data
              const updateUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${sheetRow}?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(updateUrl, {
                method: 'PUT',
                body: JSON.stringify({
                  values: [rowData]
                })
              });

              return true;
            } catch (error) {
              console.error('Error updating meal in Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Delete a meal from Google Sheets
           * @param {number} rowIndex - The row index (0-based) of the meal to delete
           * @returns {Promise<boolean>} Success status
           */
          async deleteMeal(rowIndex) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              const sheetRow = rowIndex + 2; // +2 because we start from row 2 (after header)
              
              // Clear the entire row
              const clearUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/Sheet1!A${sheetRow}:Z${sheetRow}:clear`;
              
              await this.makeAuthenticatedRequest(clearUrl, {
                method: 'POST'
              });

              return true;
            } catch (error) {
              console.error('Error deleting meal from Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Save a meal plan to Google Sheets
           * @param {Object} mealPlan - Meal plan object with name, date, and meals
           * @returns {Promise<boolean>} Success status
           */
          async saveMealPlan(mealPlan) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // Ensure the MealPlans sheet exists by trying to read it first
              await this.ensureMealPlansSheetExists();
              
              // Get current meal plans to find the next empty row
              const currentPlans = await this.loadMealPlans();
              const nextRow = currentPlans.length + 2; // +2 because we start from row 2 (after header)
              
              // Format: Plan Name | Date | Meal Count | Meal 1 | Meal 2 | Meal 3 | ...
              const rowData = [
                mealPlan.name,
                mealPlan.date,
                mealPlan.meals.length,
                ...mealPlan.meals.map(meal => meal.name)
              ];
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.MEAL_PLANS_SHEET}!A${nextRow}:append?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'POST',
                body: JSON.stringify({
                  values: [rowData]
                })
              });

              return true;
            } catch (error) {
              console.error('Error saving meal plan to Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Load meal plans from Google Sheets
           * @returns {Promise<Array>} Array of meal plan objects
           */
          async loadMealPlans() {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // Ensure the MealPlans sheet exists
              await this.ensureMealPlansSheetExists();
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.MEAL_PLANS_RANGE}`;
              
              const response = await this.makeAuthenticatedRequest(url);
              const data = await response.json();
              
              if (!data.values || data.values.length === 0) {
                return [];
              }

              // Convert sheet data to meal plan objects
              const mealPlans = data.values.slice(1).map(row => {
                if (!row[0] || row[0].trim() === '') return null;
                
                const mealCount = parseInt(row[2]) || 0;
                const meals = [];
                
                // Extract meal names starting from column 4 (index 3)
                for (let i = 3; i < 3 + mealCount && i < row.length; i++) {
                  if (row[i] && row[i].trim()) {
                    meals.push({ name: row[i].trim() });
                  }
                }
                
                return {
                  name: row[0].trim(),
                  date: row[1] || '',
                  mealCount: mealCount,
                  meals: meals
                };
              }).filter(plan => plan !== null);

              return mealPlans;
            } catch (error) {
              console.error('Error loading meal plans from Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Ensure the MealPlans sheet exists, create it if it doesn't
           * @returns {Promise<void>}
           */
          async ensureMealPlansSheetExists() {
            try {
              // Try to read from the MealPlans sheet to see if it exists
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.MEAL_PLANS_SHEET}!A1:A1`;
              
              try {
                await this.makeAuthenticatedRequest(url);
                // Sheet exists, check if it has headers
                await this.ensureMealPlansHeaders();
              } catch (error) {
                if (error.message.includes('Unable to parse range')) {
                  // Sheet doesn't exist, create it
                  await this.createMealPlansSheet();
                } else {
                  throw error;
                }
              }
            } catch (error) {
              console.error('Error ensuring MealPlans sheet exists:', error);
              throw error;
            }
          }

          /**
           * Create the MealPlans sheet with proper headers
           * @returns {Promise<void>}
           */
          async createMealPlansSheet() {
            try {
              // Add a new sheet to the spreadsheet
              const addSheetUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}:batchUpdate`;
              
              await this.makeAuthenticatedRequest(addSheetUrl, {
                method: 'POST',
                body: JSON.stringify({
                  requests: [{
                    addSheet: {
                      properties: {
                        title: this.config.MEAL_PLANS_SHEET
                      }
                    }
                  }]
                })
              });

              // Add headers to the new sheet
              await this.ensureMealPlansHeaders();
            } catch (error) {
              console.error('Error creating MealPlans sheet:', error);
              throw error;
            }
          }

          /**
           * Ensure the MealPlans sheet has proper headers
           * @returns {Promise<void>}
           */
          async ensureMealPlansHeaders() {
            try {
              const headers = ['Plan Name', 'Date', 'Meal Count', 'Meal 1', 'Meal 2', 'Meal 3', 'Meal 4', 'Meal 5', 'Meal 6', 'Meal 7', 'Meal 8', 'Meal 9', 'Meal 10', 'Meal 11', 'Meal 12', 'Meal 13', 'Meal 14'];
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.MEAL_PLANS_SHEET}!A1?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'PUT',
                body: JSON.stringify({
                  values: [headers]
                })
              });
            } catch (error) {
              console.error('Error setting MealPlans headers:', error);
              throw error;
            }
          }

          /**
           * Save an ingredient to Google Sheets
           * @param {Object} ingredient - Ingredient object with name and category
           * @returns {Promise<boolean>} Success status
           */
          async saveIngredient(ingredient) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // Ensure the Ingredients sheet exists
              await this.ensureIngredientsSheetExists();
              
              // Get current ingredients to find the next empty row
              const currentIngredients = await this.loadIngredients();
              const nextRow = currentIngredients.length + 2; // +2 because we start from row 2 (after header)
              
              // Format: Ingredient Name | Category | Date Added
              const rowData = [
                ingredient.name,
                ingredient.category || 'General',
                new Date().toLocaleDateString()
              ];
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.INGREDIENTS_SHEET}!A${nextRow}:append?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'POST',
                body: JSON.stringify({
                  values: [rowData]
                })
              });

              return true;
            } catch (error) {
              console.error('Error saving ingredient to Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Load ingredients from Google Sheets
           * @returns {Promise<Array>} Array of ingredient objects
           */
          async loadIngredients() {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // Ensure the Ingredients sheet exists
              await this.ensureIngredientsSheetExists();
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.INGREDIENTS_RANGE}`;
              
              const response = await this.makeAuthenticatedRequest(url);
              const data = await response.json();
              
              if (!data.values || data.values.length === 0) {
                return [];
              }

              // Convert sheet data to ingredient objects
              const ingredients = data.values.slice(1).map(row => {
                if (!row[0] || row[0].trim() === '') return null;
                
                return {
                  name: row[0].trim(),
                  category: row[1] || 'General',
                  dateAdded: row[2] || ''
                };
              }).filter(ingredient => ingredient !== null);

              return ingredients;
            } catch (error) {
              console.error('Error loading ingredients from Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Ensure the Ingredients sheet exists, create it if it doesn't
           * @returns {Promise<void>}
           */
          async ensureIngredientsSheetExists() {
            try {
              // Try to read from the Ingredients sheet to see if it exists
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.INGREDIENTS_SHEET}!A1:A1`;
              
              try {
                await this.makeAuthenticatedRequest(url);
                // Sheet exists, check if it has headers
                await this.ensureIngredientsHeaders();
              } catch (error) {
                if (error.message.includes('Unable to parse range')) {
                  // Sheet doesn't exist, create it
                  await this.createIngredientsSheet();
                } else {
                  throw error;
                }
              }
            } catch (error) {
              console.error('Error ensuring Ingredients sheet exists:', error);
              throw error;
            }
          }

          /**
           * Create the Ingredients sheet with proper headers
           * @returns {Promise<void>}
           */
          async createIngredientsSheet() {
            try {
              // Add a new sheet to the spreadsheet
              const addSheetUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}:batchUpdate`;
              
              await this.makeAuthenticatedRequest(addSheetUrl, {
                method: 'POST',
                body: JSON.stringify({
                  requests: [{
                    addSheet: {
                      properties: {
                        title: this.config.INGREDIENTS_SHEET
                      }
                    }
                  }]
                })
              });

              // Add headers to the new sheet
              await this.ensureIngredientsHeaders();
            } catch (error) {
              console.error('Error creating Ingredients sheet:', error);
              throw error;
            }
          }

          /**
           * Ensure the Ingredients sheet has proper headers
           * @returns {Promise<void>}
           */
          async ensureIngredientsHeaders() {
            try {
              const headers = ['Ingredient Name', 'Category', 'Date Added'];
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.INGREDIENTS_SHEET}!A1?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'PUT',
                body: JSON.stringify({
                  values: [headers]
                })
              });
            } catch (error) {
              console.error('Error setting Ingredients headers:', error);
              throw error;
            }
          }

          /**
           * Save a grocery list to Google Sheets
           * @param {Object} groceryList - Grocery list object with name, date, and items
           * @returns {Promise<boolean>} Success status
           */
          async saveGroceryList(groceryList) {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // Ensure the GroceryLists sheet exists
              await this.ensureGroceryListsSheetExists();
              
              // Get current grocery lists to find the next empty row
              const currentLists = await this.loadGroceryLists();
              const nextRow = currentLists.length + 2; // +2 because we start from row 2 (after header)
              
              // Format: List Name | Date | Item Count | Item 1 | Quantity 1 | Item 2 | Quantity 2 | ...
              const rowData = [
                groceryList.name,
                groceryList.date,
                groceryList.items.length
              ];
              
              // Add items and quantities
              groceryList.items.forEach(item => {
                rowData.push(item.name, item.quantity || 1);
              });
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.GROCERY_LISTS_SHEET}!A${nextRow}:append?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'POST',
                body: JSON.stringify({
                  values: [rowData]
                })
              });

              return true;
            } catch (error) {
              console.error('Error saving grocery list to Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Load grocery lists from Google Sheets
           * @returns {Promise<Array>} Array of grocery list objects
           */
          async loadGroceryLists() {
            if (!this.config.SHEET_ID) {
              throw new Error('Sheet ID not configured');
            }

            try {
              // Ensure the GroceryLists sheet exists
              await this.ensureGroceryListsSheetExists();
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.GROCERY_LISTS_RANGE}`;
              
              const response = await this.makeAuthenticatedRequest(url);
              const data = await response.json();
              
              if (!data.values || data.values.length === 0) {
                return [];
              }

              // Convert sheet data to grocery list objects
              const groceryLists = data.values.slice(1).map(row => {
                if (!row[0] || row[0].trim() === '') return null;
                
                const itemCount = parseInt(row[2]) || 0;
                const items = [];
                
                // Extract items and quantities starting from column 4 (index 3)
                for (let i = 3; i < 3 + (itemCount * 2); i += 2) {
                  if (row[i] && row[i].trim()) {
                    items.push({
                      name: row[i].trim(),
                      quantity: parseInt(row[i + 1]) || 1
                    });
                  }
                }
                
                return {
                  name: row[0].trim(),
                  date: row[1] || '',
                  itemCount: itemCount,
                  items: items
                };
              }).filter(list => list !== null);

              return groceryLists;
            } catch (error) {
              console.error('Error loading grocery lists from Google Sheets:', error);
              throw error;
            }
          }

          /**
           * Ensure the GroceryLists sheet exists, create it if it doesn't
           * @returns {Promise<void>}
           */
          async ensureGroceryListsSheetExists() {
            try {
              // Try to read from the GroceryLists sheet to see if it exists
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.GROCERY_LISTS_SHEET}!A1:A1`;
              
              try {
                await this.makeAuthenticatedRequest(url);
                // Sheet exists, check if it has headers
                await this.ensureGroceryListsHeaders();
              } catch (error) {
                if (error.message.includes('Unable to parse range')) {
                  // Sheet doesn't exist, create it
                  await this.createGroceryListsSheet();
                } else {
                  throw error;
                }
              }
            } catch (error) {
              console.error('Error ensuring GroceryLists sheet exists:', error);
              throw error;
            }
          }

          /**
           * Create the GroceryLists sheet with proper headers
           * @returns {Promise<void>}
           */
          async createGroceryListsSheet() {
            try {
              // Add a new sheet to the spreadsheet
              const addSheetUrl = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}:batchUpdate`;
              
              await this.makeAuthenticatedRequest(addSheetUrl, {
                method: 'POST',
                body: JSON.stringify({
                  requests: [{
                    addSheet: {
                      properties: {
                        title: this.config.GROCERY_LISTS_SHEET
                      }
                    }
                  }]
                })
              });

              // Add headers to the new sheet
              await this.ensureGroceryListsHeaders();
            } catch (error) {
              console.error('Error creating GroceryLists sheet:', error);
              throw error;
            }
          }

          /**
           * Ensure the GroceryLists sheet has proper headers
           * @returns {Promise<void>}
           */
          async ensureGroceryListsHeaders() {
            try {
              const headers = ['List Name', 'Date', 'Item Count', 'Item 1', 'Quantity 1', 'Item 2', 'Quantity 2', 'Item 3', 'Quantity 3', 'Item 4', 'Quantity 4', 'Item 5', 'Quantity 5', 'Item 6', 'Quantity 6', 'Item 7', 'Quantity 7', 'Item 8', 'Quantity 8', 'Item 9', 'Quantity 9', 'Item 10', 'Quantity 10'];
              
              const url = `${this.config.API_BASE_URL}/${this.config.SHEET_ID}/values/${this.config.GROCERY_LISTS_SHEET}!A1?valueInputOption=RAW`;
              
              await this.makeAuthenticatedRequest(url, {
                method: 'PUT',
                body: JSON.stringify({
                  values: [headers]
                })
              });
            } catch (error) {
              console.error('Error setting GroceryLists headers:', error);
              throw error;
            }
          }
        }

        // Make it globally available
        window.GoogleSheetsService = GoogleSheetsService;
        window.CONFIG = CONFIG;
    </script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }
        
        code {
            font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
                monospace;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;
        // Simple icon replacements
        const Shuffle = () => "🎲";
        const ShoppingCart = () => "🛒";
        const Plus = () => "➕";
        const X = () => "❌";
        const RefreshCw = () => "🔄";
        const Save = () => "💾";
        const Edit = () => "✏️";

        const MealPlanner = () => {
          // Initialize Google Sheets service
          const [sheetsService] = useState(() => new GoogleSheetsService());
          const [isLoadingSheets, setIsLoadingSheets] = useState(false);
          const [sheetsError, setSheetsError] = useState(null);
          const [useLocalData, setUseLocalData] = useState(true);
          const [isSignedIn, setIsSignedIn] = useState(false);
          const [userInfo, setUserInfo] = useState(null);

          // Your historic meals (fallback data)
          const sampleMeals = [
            { name: "Ahi tuna salad", ingredients: [] },
            { name: "Alfredo chicken", ingredients: [] },
            { name: "Alfredo meatballs", ingredients: [] },
            { name: "Baby back ribs", ingredients: [] },
            { name: "Bacon Wrapped chicken", ingredients: [] },
            { name: "Bacon Wrapped pork loin", ingredients: [] },
            { name: "Baked feta pasta", ingredients: [] },
            { name: "Baked Potato", ingredients: [] },
            { name: "Baked ziti", ingredients: [] },
            { name: "Bbq kielbasa", ingredients: [] },
            { name: "Beef and broccoli", ingredients: [] },
            { name: "Beer brats", ingredients: [] },
            { name: "Biscuits and Gravy", ingredients: [] },
            { name: "Blackened Salmon", ingredients: [] },
            { name: "Brats", ingredients: [] },
            { name: "Breakfast Skillet", ingredients: [] },
            { name: "Brisket", ingredients: [] },
            { name: "Bulgogi Sauce Meatballs", ingredients: [] },
            { name: "Burger bowls", ingredients: [] },
            { name: "Burrito bowls", ingredients: [] },
            { name: "Burritos", ingredients: [] },
            { name: "Butter chicken", ingredients: [] },
            { name: "Cajun shrimp alfredo", ingredients: [] },
            { name: "Chef Salad", ingredients: [] },
            { name: "Chicken and shrimp tacos", ingredients: [] },
            { name: "Chicken bacon carbonara", ingredients: [] },
            { name: "Chicken Caesar Salad", ingredients: [] },
            { name: "Chicken cordon bleu", ingredients: [] },
            { name: "Chicken Fried steak", ingredients: [] },
            { name: "Chicken Marinara", ingredients: [] },
            { name: "Chicken Noodle Soup", ingredients: [] },
            { name: "Chicken Quesadilla", ingredients: [] },
            { name: "Chicken Sandwiches", ingredients: [] },
            { name: "Chicken taco", ingredients: [] },
            { name: "Chicken teriyaki", ingredients: [] },
            { name: "Chicken tort alfredo", ingredients: [] },
            { name: "Chili - Traditional", ingredients: [] },
            { name: "Chili verde", ingredients: [] },
            { name: "Chuck Pot Roast", ingredients: [] },
            { name: "Crab legs", ingredients: [] },
            { name: "Creamy Tostadas", ingredients: [] },
            { name: "Crispy Franks redhot chicken (hello)", ingredients: [] },
            { name: "Fajita bowl", ingredients: [] },
            { name: "Fajitas", ingredients: [] },
            { name: "Flautas (hello)", ingredients: [] },
            { name: "French Dip", ingredients: [] },
            { name: "General Tso", ingredients: [] },
            { name: "Grilled Chicken", ingredients: [] },
            { name: "Grilled Chicken thighs", ingredients: [] },
            { name: "Grilled Sammies", ingredients: [] },
            { name: "Hamburgers", ingredients: [] },
            { name: "Hibachi filet mignon", ingredients: [] },
            { name: "Hibachi Stir Fry", ingredients: [] },
            { name: "Honey garlic pork chops", ingredients: [] },
            { name: "Honey sriracha chicken", ingredients: [] },
            { name: "Hot Dogs", ingredients: [] },
            { name: "Italian Chicken pasta", ingredients: [] },
            { name: "Kabobs", ingredients: [] },
            { name: "Kielbasa in vodka sauce", ingredients: [] },
            { name: "Kung Pao chicken", ingredients: [] },
            { name: "Lasagna", ingredients: [] },
            { name: "Lobster", ingredients: [] },
            { name: "Meat Loaf", ingredients: [] },
            { name: "Meatballs", ingredients: [] },
            { name: "Minestrone Soup", ingredients: [] },
            { name: "Mongolian beef", ingredients: [] },
            { name: "Navajo Tacos", ingredients: [] },
            { name: "Orange Chicken", ingredients: [] },
            { name: "Pepper steak", ingredients: [] },
            { name: "Pesto Chicken", ingredients: [] },
            { name: "Philly cheese steaks", ingredients: [] },
            { name: "Pizza", ingredients: [] },
            { name: "Poke", ingredients: [] },
            { name: "Pork bulgogi bowls (hello)", ingredients: [] },
            { name: "Pork Flautas", ingredients: [] },
            { name: "Pork Tenderloin", ingredients: [] },
            { name: "Pot Pie", ingredients: [] },
            { name: "Pot roast", ingredients: [] },
            { name: "Potato Soup", ingredients: [] },
            { name: "pulled pork", ingredients: [] },
            { name: "pulled pork pitas", ingredients: [] },
            { name: "Red beans and rice", ingredients: [] },
            { name: "Rib eye steaks", ingredients: [] },
            { name: "Ribs", ingredients: [] },
            { name: "Salmon", ingredients: [] },
            { name: "Shake and Bake", ingredients: [] },
            { name: "Shrimp burrito", ingredients: [] },
            { name: "Shrimp scampi", ingredients: [] },
            { name: "Sloppy joes", ingredients: [] },
            { name: "Soup And Sandwiches", ingredients: [] },
            { name: "South west pasta", ingredients: [] },
            { name: "Spaghetti", ingredients: [] },
            { name: "Spicy Kielbasa pasta", ingredients: [] },
            { name: "Steak & lobster", ingredients: [] },
            { name: "Steak & potatoes", ingredients: [] },
            { name: "Steak burgers", ingredients: [] },
            { name: "Stevie Feel good", ingredients: [] },
            { name: "Stew", ingredients: [] },
            { name: "Stir fry", ingredients: [] },
            { name: "Stuffed Peppers", ingredients: [] },
            { name: "Stuffed shells", ingredients: [] },
            { name: "Sweet and sour chicken", ingredients: [] },
            { name: "Sweet chili chicken (every plate)", ingredients: [] },
            { name: "Sweet fire chicken", ingredients: [] },
            { name: "Sweet pork", ingredients: [] },
            { name: "Sweet pork burritos", ingredients: [] },
            { name: "Szechuan beef noodles (hello)", ingredients: [] },
            { name: "Taco Mac", ingredients: [] },
            { name: "Taco Salad", ingredients: [] },
            { name: "Taco soup", ingredients: [] },
            { name: "Tamale pie", ingredients: [] },
            { name: "Tamales", ingredients: [] },
            { name: "Tater Tot Casserole", ingredients: [] },
            { name: "Thai coconut pork meatballs (Hello)", ingredients: [] },
            { name: "Thick pork chops", ingredients: [] },
            { name: "Thin pork chops", ingredients: [] },
            { name: "Tortellini soup", ingredients: [] },
            { name: "Tots and gravy", ingredients: [] },
            { name: "Tri-Tip", ingredients: [] },
            { name: "Tuscany tort", ingredients: [] },
            { name: "Waffles", ingredients: [] },
            { name: "Walking tacos", ingredients: [] },
            { name: "White Chicken Chilli", ingredients: [] },
            { name: "White gravy pork chops", ingredients: [] },
            { name: "Whole roasted chicken", ingredients: [] },
            { name: "Chicken Bacon ranch pasta", ingredients: [] }
          ];

          const [mealCount, setMealCount] = useState(7);
          const [selectedMeals, setSelectedMeals] = useState([]);
          const [showGroceryList, setShowGroceryList] = useState(false);
          const [allMeals, setAllMeals] = useState(sampleMeals);
          const [showAddMeal, setShowAddMeal] = useState(false);
          const [newMealName, setNewMealName] = useState('');
          const [newMealIngredients, setNewMealIngredients] = useState(['']);
          const [editingMealIndex, setEditingMealIndex] = useState(-1);
          const [showMealList, setShowMealList] = useState(false);

          // Meal Plan state
          const [savedMealPlans, setSavedMealPlans] = useState([]);
          const [showSaveMealPlan, setShowSaveMealPlan] = useState(false);
          const [showLoadMealPlan, setShowLoadMealPlan] = useState(false);
          const [mealPlanName, setMealPlanName] = useState('');
          const [isLoadingMealPlans, setIsLoadingMealPlans] = useState(false);

          // Search and slot selection state
          const [showMealSearch, setShowMealSearch] = useState(false);
          const [searchQuery, setSearchQuery] = useState('');
          const [selectedSlotIndex, setSelectedSlotIndex] = useState(-1);
          const [filteredMeals, setFilteredMeals] = useState([]);

          // Ingredients management state
          const [showIngredientsManager, setShowIngredientsManager] = useState(false);
          const [ingredients, setIngredients] = useState([]);
          const [newIngredientName, setNewIngredientName] = useState('');
          const [newIngredientCategory, setNewIngredientCategory] = useState('General');
          const [isLoadingIngredients, setIsLoadingIngredients] = useState(false);

          // Grocery list management state
          const [manualGroceryList, setManualGroceryList] = useState([]);
          const [newGroceryItem, setNewGroceryItem] = useState('');
          const [newGroceryQuantity, setNewGroceryQuantity] = useState(1);
          const [showSaveGroceryList, setShowSaveGroceryList] = useState(false);
          const [showLoadGroceryList, setShowLoadGroceryList] = useState(false);
          const [groceryListName, setGroceryListName] = useState('');
          const [savedGroceryLists, setSavedGroceryLists] = useState([]);
          const [isLoadingGroceryLists, setIsLoadingGroceryLists] = useState(false);

          // Sign in with Google OAuth2
          const signInWithGoogle = async () => {
            setIsLoadingSheets(true);
            setSheetsError(null);
            
            try {
              await sheetsService.signIn();
              setIsSignedIn(true);
              
              // Load meals and meal plans after successful sign-in
              if (!useLocalData) {
                await loadMealsFromSheets();
                await loadSavedMealPlans();
                await loadIngredients();
                await loadSavedGroceryLists();
              }
            } catch (error) {
              console.error('Failed to sign in:', error);
              setSheetsError(error.message);
              setIsSignedIn(false);
            } finally {
              setIsLoadingSheets(false);
            }
          };

          // Sign out from Google OAuth2
          const signOutFromGoogle = async () => {
            try {
              await sheetsService.signOut();
              setIsSignedIn(false);
              setUserInfo(null);
              
              // Switch back to local data
              if (!useLocalData) {
                setUseLocalData(true);
                setAllMeals(sampleMeals);
              }
            } catch (error) {
              console.error('Failed to sign out:', error);
              setSheetsError(error.message);
            }
          };

          // Load meals from Google Sheets
          const loadMealsFromSheets = async () => {
            if (useLocalData || !isSignedIn) return;
            
            setIsLoadingSheets(true);
            setSheetsError(null);
            
            try {
              const meals = await sheetsService.readMeals();
              setAllMeals(meals.length > 0 ? meals : sampleMeals);
              console.log('Loaded meals from Google Sheets:', meals.length);
            } catch (error) {
              console.error('Failed to load from Google Sheets:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
              setAllMeals(sampleMeals); // Fallback to local data
            } finally {
              setIsLoadingSheets(false);
            }
          };

          // Save meal to Google Sheets
          const saveMealToSheets = async (meal, isUpdate = false, originalIndex = -1) => {
            if (useLocalData || !isSignedIn) return true;
            
            try {
              if (isUpdate) {
                await sheetsService.updateMeal(originalIndex, meal);
              } else {
                await sheetsService.addMeal(meal);
              }
              return true;
            } catch (error) {
              console.error('Failed to save to Google Sheets:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
              return false;
            }
          };

          // Initialize OAuth2 when component mounts
          const initializeOAuth = async () => {
            try {
              await sheetsService.initializeOAuth();
            } catch (error) {
              console.error('Failed to initialize OAuth:', error);
              setSheetsError(error.message);
            }
          };

          // Load saved meal plans from Google Sheets
          const loadSavedMealPlans = async () => {
            if (useLocalData || !isSignedIn) return;
            
            setIsLoadingMealPlans(true);
            setSheetsError(null);
            
            try {
              const plans = await sheetsService.loadMealPlans();
              setSavedMealPlans(plans);
              console.log('Loaded meal plans from Google Sheets:', plans.length);
            } catch (error) {
              console.error('Failed to load meal plans from Google Sheets:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
            } finally {
              setIsLoadingMealPlans(false);
            }
          };

          // Save current meal plan to Google Sheets
          const saveMealPlan = async () => {
            if (useLocalData || !isSignedIn || selectedMeals.length === 0) return;
            
            if (!mealPlanName.trim()) {
              setSheetsError('Please enter a name for the meal plan');
              return;
            }

            setIsLoadingMealPlans(true);
            setSheetsError(null);
            
            try {
              const mealPlan = {
                name: mealPlanName.trim(),
                date: new Date().toLocaleDateString(),
                meals: selectedMeals
              };
              
              await sheetsService.saveMealPlan(mealPlan);
              
              // Refresh the saved meal plans list
              await loadSavedMealPlans();
              
              // Reset form
              setMealPlanName('');
              setShowSaveMealPlan(false);
              
              console.log('Meal plan saved successfully');
            } catch (error) {
              console.error('Failed to save meal plan:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
            } finally {
              setIsLoadingMealPlans(false);
            }
          };

          // Load a specific meal plan
          const loadMealPlan = async (planIndex) => {
            if (planIndex < 0 || planIndex >= savedMealPlans.length) return;
            
            const plan = savedMealPlans[planIndex];
            
            // Find the full meal objects from allMeals based on the plan's meal names
            const loadedMeals = plan.meals.map(planMeal => {
              const fullMeal = allMeals.find(meal => meal.name === planMeal.name);
              return fullMeal || { name: planMeal.name, ingredients: [] };
            });
            
            setSelectedMeals(loadedMeals);
            setMealCount(loadedMeals.length);
            setShowLoadMealPlan(false);
            setShowGroceryList(false);
            
            console.log(`Loaded meal plan: ${plan.name}`);
          };

          // Search meals functionality
          const handleSearchMeals = (query) => {
            setSearchQuery(query);
            if (query.trim() === '') {
              setFilteredMeals([]);
            } else {
              const filtered = allMeals.filter(meal => 
                meal.name.toLowerCase().includes(query.toLowerCase())
              );
              setFilteredMeals(filtered);
            }
          };

          // Open meal search for specific slot
          const openMealSearchForSlot = (slotIndex) => {
            setSelectedSlotIndex(slotIndex);
            setShowMealSearch(true);
            setSearchQuery('');
            setFilteredMeals(allMeals.slice(0, 20)); // Show first 20 meals by default
          };

          // Add meal to specific slot
          const addMealToSlot = (meal) => {
            if (selectedSlotIndex >= 0 && selectedSlotIndex < selectedMeals.length) {
              const newMeals = [...selectedMeals];
              newMeals[selectedSlotIndex] = meal;
              setSelectedMeals(newMeals);
              setShowMealSearch(false);
              setSelectedSlotIndex(-1);
              setSearchQuery('');
              setFilteredMeals([]);
            }
          };

          // Load ingredients from Google Sheets
          const loadIngredients = async () => {
            if (useLocalData || !isSignedIn) return;
            
            setIsLoadingIngredients(true);
            setSheetsError(null);
            
            try {
              const loadedIngredients = await sheetsService.loadIngredients();
              setIngredients(loadedIngredients);
              console.log('Loaded ingredients from Google Sheets:', loadedIngredients.length);
            } catch (error) {
              console.error('Failed to load ingredients from Google Sheets:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
            } finally {
              setIsLoadingIngredients(false);
            }
          };

          // Save new ingredient
          const saveIngredient = async () => {
            if (useLocalData || !isSignedIn || !newIngredientName.trim()) return;
            
            setIsLoadingIngredients(true);
            setSheetsError(null);
            
            try {
              const ingredient = {
                name: newIngredientName.trim(),
                category: newIngredientCategory
              };
              
              await sheetsService.saveIngredient(ingredient);
              
              // Refresh ingredients list
              await loadIngredients();
              
              // Reset form
              setNewIngredientName('');
              setNewIngredientCategory('General');
              
              console.log('Ingredient saved successfully');
            } catch (error) {
              console.error('Failed to save ingredient:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
            } finally {
              setIsLoadingIngredients(false);
            }
          };

          // Add item to manual grocery list
          const addToGroceryList = () => {
            if (newGroceryItem.trim()) {
              const newItem = {
                name: newGroceryItem.trim(),
                quantity: newGroceryQuantity
              };
              
              // Check if item already exists, if so, update quantity
              const existingIndex = manualGroceryList.findIndex(item => 
                item.name.toLowerCase() === newItem.name.toLowerCase()
              );
              
              if (existingIndex >= 0) {
                const updatedList = [...manualGroceryList];
                updatedList[existingIndex].quantity += newItem.quantity;
                setManualGroceryList(updatedList);
              } else {
                setManualGroceryList([...manualGroceryList, newItem]);
              }
              
              setNewGroceryItem('');
              setNewGroceryQuantity(1);
            }
          };

          // Remove item from manual grocery list
          const removeFromGroceryList = (index) => {
            const updatedList = manualGroceryList.filter((_, i) => i !== index);
            setManualGroceryList(updatedList);
          };

          // Update item quantity in grocery list
          const updateGroceryItemQuantity = (index, quantity) => {
            const updatedList = [...manualGroceryList];
            updatedList[index].quantity = Math.max(1, quantity);
            setManualGroceryList(updatedList);
          };

          // Generate enhanced grocery list (from meals + manual items)
          const generateEnhancedGroceryList = () => {
            const mealIngredients = selectedMeals.flatMap(meal => meal.ingredients || []);
            const ingredientCount = {};
            
            // Count ingredients from meals
            mealIngredients.forEach(ingredient => {
              ingredientCount[ingredient.toLowerCase()] = (ingredientCount[ingredient.toLowerCase()] || 0) + 1;
            });

            // Add manual grocery items
            manualGroceryList.forEach(item => {
              const key = item.name.toLowerCase();
              ingredientCount[key] = (ingredientCount[key] || 0) + item.quantity;
            });
            
            return Object.entries(ingredientCount)
              .map(([name, count]) => ({ name, quantity: count }))
              .sort((a, b) => a.name.localeCompare(b.name));
          };

          // Save grocery list to Google Sheets
          const saveGroceryList = async () => {
            if (useLocalData || !isSignedIn) return;
            
            if (!groceryListName.trim()) {
              setSheetsError('Please enter a name for the grocery list');
              return;
            }

            setIsLoadingGroceryLists(true);
            setSheetsError(null);
            
            try {
              const enhancedList = generateEnhancedGroceryList();
              
              const groceryList = {
                name: groceryListName.trim(),
                date: new Date().toLocaleDateString(),
                items: enhancedList
              };
              
              await sheetsService.saveGroceryList(groceryList);
              
              // Refresh saved grocery lists
              await loadSavedGroceryLists();
              
              // Reset form
              setGroceryListName('');
              setShowSaveGroceryList(false);
              
              console.log('Grocery list saved successfully');
            } catch (error) {
              console.error('Failed to save grocery list:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
            } finally {
              setIsLoadingGroceryLists(false);
            }
          };

          // Load saved grocery lists
          const loadSavedGroceryLists = async () => {
            if (useLocalData || !isSignedIn) return;
            
            setIsLoadingGroceryLists(true);
            setSheetsError(null);
            
            try {
              const lists = await sheetsService.loadGroceryLists();
              setSavedGroceryLists(lists);
              console.log('Loaded grocery lists from Google Sheets:', lists.length);
            } catch (error) {
              console.error('Failed to load grocery lists from Google Sheets:', error);
              setSheetsError(error.message);
              if (error.message.includes('Authentication expired')) {
                setIsSignedIn(false);
              }
            } finally {
              setIsLoadingGroceryLists(false);
            }
          };

          // Load a specific grocery list
          const loadGroceryList = (listIndex) => {
            if (listIndex < 0 || listIndex >= savedGroceryLists.length) return;
            
            const list = savedGroceryLists[listIndex];
            setManualGroceryList(list.items);
            setShowLoadGroceryList(false);
            setShowGroceryList(true);
            
            console.log(`Loaded grocery list: ${list.name}`);
          };

          // Toggle between local and Google Sheets data
          const toggleDataSource = async () => {
            const newUseLocalData = !useLocalData;
            setUseLocalData(newUseLocalData);
            
            if (!newUseLocalData) {
              // Switching to Google Sheets - need to sign in
              if (!isSignedIn) {
                try {
                  await signInWithGoogle();
                } catch (error) {
                  // If sign-in fails, revert back to local data
                  setUseLocalData(true);
                  setAllMeals(sampleMeals);
                }
              } else {
                // Already signed in, just load data
                await loadMealsFromSheets();
              }
            } else {
              // Switching to local data
              setAllMeals(sampleMeals);
              setSheetsError(null);
            }
          };

          // Add a new ingredient input field
          const addIngredientField = () => {
            setNewMealIngredients([...newMealIngredients, '']);
          };

          // Remove an ingredient input field
          const removeIngredientField = (index) => {
            const filtered = newMealIngredients.filter((_, i) => i !== index);
            setNewMealIngredients(filtered.length > 0 ? filtered : ['']);
          };

          // Update ingredient at specific index
          const updateIngredient = (index, value) => {
            const updated = [...newMealIngredients];
            updated[index] = value;
            setNewMealIngredients(updated);
          };

          // Start editing a meal
          const startEditMeal = (index) => {
            const meal = allMeals[index];
            setNewMealName(meal.name);
            setNewMealIngredients(meal.ingredients.length > 0 ? meal.ingredients : ['']);
            setEditingMealIndex(index);
            setShowAddMeal(true);
          };

          // Save new meal or update existing
          const saveNewMeal = async () => {
            if (newMealName.trim()) {
              const filteredIngredients = newMealIngredients.filter(ing => ing.trim() !== '');
              const mealData = {
                name: newMealName.trim(),
                ingredients: filteredIngredients
              };
              
              if (editingMealIndex >= 0) {
                // Update existing meal
                const updatedMeals = [...allMeals];
                updatedMeals[editingMealIndex] = mealData;
                
                // Try to save to Google Sheets
                const success = await saveMealToSheets(mealData, true, editingMealIndex);
                if (success || useLocalData) {
                  setAllMeals(updatedMeals);
                  
                  // Update selected meals if the edited meal is currently selected
                  setSelectedMeals(prev => 
                    prev.map(meal => 
                      meal.name === allMeals[editingMealIndex].name ? mealData : meal
                    )
                  );
                }
              } else {
                // Add new meal
                const success = await saveMealToSheets(mealData, false);
                if (success || useLocalData) {
                  setAllMeals([...allMeals, mealData]);
                }
              }
              
              resetMealForm();
            }
          };

          // Reset the meal form
          const resetMealForm = () => {
            setNewMealName('');
            setNewMealIngredients(['']);
            setShowAddMeal(false);
            setEditingMealIndex(-1);
          };

          // Cancel adding/editing meal
          const cancelAddMeal = () => {
            resetMealForm();
          };

          // Generate random meals
          const generateRandomMeals = () => {
            const shuffled = [...allMeals].sort(() => 0.5 - Math.random());
            setSelectedMeals(shuffled.slice(0, mealCount));
            setShowGroceryList(false);
          };

          // Replace a specific meal
          const replaceMeal = (index) => {
            const usedMealNames = selectedMeals.map(meal => meal.name);
            const availableMeals = allMeals.filter(meal => !usedMealNames.includes(meal.name));
            
            if (availableMeals.length > 0) {
              const randomMeal = availableMeals[Math.floor(Math.random() * availableMeals.length)];
              const newMeals = [...selectedMeals];
              newMeals[index] = randomMeal;
              setSelectedMeals(newMeals);
            }
          };

          // Generate grocery list
          const generateGroceryList = () => {
            const allIngredients = selectedMeals.flatMap(meal => meal.ingredients);
            const ingredientCount = {};
            
            allIngredients.forEach(ingredient => {
              ingredientCount[ingredient] = (ingredientCount[ingredient] || 0) + 1;
            });
            
            return Object.entries(ingredientCount).sort();
          };

          // Auto-generate meals when meal count changes
          useEffect(() => {
            if (mealCount > 0) {
              generateRandomMeals();
            }
          }, [mealCount]);

          // Initialize OAuth2 on component mount
          useEffect(() => {
            initializeOAuth();
          }, []);

          return (
            <div className="max-w-4xl mx-auto p-6 bg-white">
              <h1 className="text-3xl font-bold text-gray-800 mb-8 text-center">Meal Planner</h1>
              
              {/* Data Source Toggle */}
              <div className="bg-yellow-50 p-6 rounded-lg mb-6 border border-yellow-200">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h2 className="text-lg font-medium text-gray-800">Data Source</h2>
                    <p className="text-sm text-gray-600">
                      Choose between local data or Google Sheets integration with OAuth2
                    </p>
                  </div>
                  <div className="flex items-center space-x-4">
                    <label className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={!useLocalData}
                        onChange={toggleDataSource}
                        className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      />
                      <span className="text-sm font-medium text-gray-700">
                        Use Google Sheets
                      </span>
                    </label>
                  </div>
                </div>
                
                {/* OAuth2 Authentication */}
                {!useLocalData && (
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Google Authentication
                    </label>
                    
                    {!isSignedIn ? (
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={signInWithGoogle}
                          disabled={isLoadingSheets}
                          className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 transition-colors"
                        >
                          <span>🔐</span>
                          <span>{isLoadingSheets ? 'Signing in...' : 'Sign in with Google'}</span>
                        </button>
                        <p className="text-sm text-gray-600">
                          Sign in to read and write meal data to Google Sheets
                        </p>
                      </div>
                    ) : (
                      <div className="flex items-center justify-between bg-green-50 p-3 rounded-lg border border-green-200">
                        <div className="flex items-center space-x-2">
                          <span className="text-green-600">✓</span>
                          <span className="text-sm text-green-800 font-medium">
                            Signed in to Google Sheets
                          </span>
                        </div>
                        <div className="flex items-center space-x-2">
                          <button
                            onClick={loadMealsFromSheets}
                            disabled={isLoadingSheets}
                            className="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 transition-colors text-sm"
                          >
                            {isLoadingSheets ? 'Loading...' : 'Refresh Data'}
                          </button>
                          <button
                            onClick={signOutFromGoogle}
                            className="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm"
                          >
                            Sign Out
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                )}
                
                {/* Error Message */}
                {sheetsError && (
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 className="font-medium text-red-800 mb-2">Google Sheets Error</h3>
                    <p className="text-sm text-red-700 mb-3">{sheetsError}</p>
                    <p className="text-xs text-red-600">
                      {sheetsError.includes('Authentication expired') ? 
                        'Please sign in again to continue using Google Sheets.' :
                        'Using local data as fallback. Please check your configuration and try again.'
                      }
                    </p>
                  </div>
                )}
                
                {/* Status */}
                <div className="text-sm text-gray-600">
                  <strong>Status:</strong> {useLocalData ? 'Using local data' : 
                    isLoadingSheets ? 'Loading from Google Sheets...' : 
                    sheetsError ? 'Using local data (Google Sheets error)' : 
                    isSignedIn ? 'Connected to Google Sheets' : 'Sign in to connect to Google Sheets'}
                </div>
              </div>
              
              {/* Add New Meal Section */}
              <div className="bg-purple-50 p-6 rounded-lg mb-6">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-lg font-medium text-gray-800">Meal Database</h2>
                  <div className="flex items-center space-x-4">
                    <span className="text-sm text-gray-600">
                      Total meals: {allMeals.length}
                    </span>
                    <button
                      onClick={() => setShowMealList(!showMealList)}
                      className="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors"
                    >
                      {showMealList ? 'Hide' : 'View'} All Meals
                    </button>
                    {!showAddMeal && (
                      <button
                        onClick={() => {
                          setEditingMealIndex(-1);
                          setShowAddMeal(true);
                        }}
                        className="flex items-center space-x-2 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors"
                      >
                        <span>➕</span>
                        <span>Add New Meal</span>
                      </button>
                    )}
                  </div>
                </div>

                {/* Meal List for Editing */}
                {showMealList && !showAddMeal && (
                  <div className="bg-white p-4 rounded-lg border-2 border-purple-200 mb-4">
                    <h3 className="font-medium text-gray-800 mb-4">All Meals</h3>
                    <div className="max-h-64 overflow-y-auto space-y-2">
                      {allMeals.map((meal, index) => (
                        <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex-1">
                            <h4 className="font-medium text-gray-800">{meal.name}</h4>
                            <p className="text-sm text-gray-600">
                              {meal.ingredients && meal.ingredients.length > 0 
                                ? `${meal.ingredients.length} ingredients`
                                : 'No ingredients'
                              }
                            </p>
                          </div>
                          <button
                            onClick={() => startEditMeal(index)}
                            className="flex items-center space-x-1 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                          >
                            <span>✏️</span>
                            <span>Edit</span>
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {showAddMeal && (
                  <div className="bg-white p-4 rounded-lg border-2 border-purple-200">
                    <h3 className="font-medium text-gray-800 mb-4">
                      {editingMealIndex >= 0 ? 'Edit Meal' : 'Add New Meal'}
                    </h3>
                    
                    {/* Meal Name Input */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Meal Name
                      </label>
                      <input
                        type="text"
                        value={newMealName}
                        onChange={(e) => setNewMealName(e.target.value)}
                        placeholder="Enter meal name..."
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                      />
                    </div>

                    {/* Ingredients Input */}
                    <div className="mb-4">
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Ingredients
                      </label>
                      <div className="space-y-2">
                        {newMealIngredients.map((ingredient, index) => (
                          <div key={index} className="flex items-center space-x-2">
                            <input
                              type="text"
                              value={ingredient}
                              onChange={(e) => updateIngredient(index, e.target.value)}
                              placeholder="Enter ingredient..."
                              className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                            {newMealIngredients.length > 1 && (
                              <button
                                onClick={() => removeIngredientField(index)}
                                className="p-2 text-red-500 hover:bg-red-50 rounded-md"
                              >
                                <span>❌</span>
                              </button>
                            )}
                          </div>
                        ))}
                        <button
                          onClick={addIngredientField}
                          className="flex items-center space-x-1 px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors"
                        >
                          <span>➕</span>
                          <span>Add Ingredient</span>
                        </button>
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex items-center space-x-3">
                      <button
                        onClick={saveNewMeal}
                        disabled={!newMealName.trim()}
                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                      >
                        <span>💾</span>
                        <span>{editingMealIndex >= 0 ? 'Update Meal' : 'Save Meal'}</span>
                      </button>
                      <button
                        onClick={cancelAddMeal}
                        className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                )}
              </div>

              {/* Ingredients Management Section */}
              {!useLocalData && isSignedIn && (
                <div className="bg-green-50 p-6 rounded-lg mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-lg font-medium text-gray-800">Ingredients Database</h2>
                    <div className="flex items-center space-x-4">
                      <span className="text-sm text-gray-600">
                        Total ingredients: {ingredients.length}
                      </span>
                      <button
                        onClick={() => {
                          setShowIngredientsManager(!showIngredientsManager);
                          if (!showIngredientsManager) loadIngredients();
                        }}
                        disabled={isLoadingIngredients}
                        className="flex items-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 transition-colors"
                      >
                        <span>🥕</span>
                        <span>{showIngredientsManager ? 'Hide' : 'Manage'} Ingredients</span>
                      </button>
                    </div>
                  </div>

                  {showIngredientsManager && (
                    <div>
                      {/* Add New Ingredient Form */}
                      <div className="bg-white p-4 rounded-lg border-2 border-green-200 mb-4">
                        <h3 className="font-medium text-gray-800 mb-4">Add New Ingredient</h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Ingredient Name
                            </label>
                            <input
                              type="text"
                              value={newIngredientName}
                              onChange={(e) => setNewIngredientName(e.target.value)}
                              placeholder="Enter ingredient name..."
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                          </div>
                          
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">
                              Category
                            </label>
                            <select
                              value={newIngredientCategory}
                              onChange={(e) => setNewIngredientCategory(e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                              <option value="General">General</option>
                              <option value="Protein">Protein</option>
                              <option value="Vegetables">Vegetables</option>
                              <option value="Fruits">Fruits</option>
                              <option value="Dairy">Dairy</option>
                              <option value="Grains">Grains</option>
                              <option value="Spices">Spices</option>
                              <option value="Condiments">Condiments</option>
                              <option value="Frozen">Frozen</option>
                              <option value="Pantry">Pantry</option>
                            </select>
                          </div>
                          
                          <div className="flex items-end">
                            <button
                              onClick={saveIngredient}
                              disabled={!newIngredientName.trim() || isLoadingIngredients}
                              className="w-full flex items-center justify-center space-x-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                            >
                              <span>💾</span>
                              <span>{isLoadingIngredients ? 'Saving...' : 'Save Ingredient'}</span>
                            </button>
                          </div>
                        </div>
                      </div>

                      {/* Ingredients List */}
                      <div className="bg-white p-4 rounded-lg border-2 border-green-200">
                        <h3 className="font-medium text-gray-800 mb-4">All Ingredients</h3>
                        {ingredients.length > 0 ? (
                          <div className="max-h-64 overflow-y-auto">
                            {/* Group ingredients by category */}
                            {Object.entries(
                              ingredients.reduce((acc, ingredient) => {
                                const category = ingredient.category || 'General';
                                if (!acc[category]) acc[category] = [];
                                acc[category].push(ingredient);
                                return acc;
                              }, {})
                            ).map(([category, categoryIngredients]) => (
                              <div key={category} className="mb-4">
                                <h4 className="font-medium text-green-800 mb-2 border-b border-green-200 pb-1">
                                  {category} ({categoryIngredients.length})
                                </h4>
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                                  {categoryIngredients.map((ingredient, index) => (
                                    <div key={index} className="bg-green-50 p-2 rounded-lg border border-green-100">
                                      <span className="text-sm text-gray-700">{ingredient.name}</span>
                                      {ingredient.dateAdded && (
                                        <p className="text-xs text-gray-500 mt-1">
                                          Added: {ingredient.dateAdded}
                                        </p>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p className="text-gray-600 text-center py-4">
                            {isLoadingIngredients ? 'Loading ingredients...' : 'No ingredients found. Add some ingredients above!'}
                          </p>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Meal Count Selector */}
              <div className="bg-blue-50 p-6 rounded-lg mb-6">
                <label className="block text-lg font-medium text-gray-700 mb-3">
                  How many meals do you want to plan?
                </label>
                <div className="flex items-center space-x-4">
                  <input
                    type="number"
                    min="1"
                    max="14"
                    value={mealCount}
                    onChange={(e) => setMealCount(parseInt(e.target.value) || 1)}
                    className="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                  <button
                    onClick={generateRandomMeals}
                    className="flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                  >
                    <span>🎲</span>
                    <span>Generate New Plan</span>
                  </button>
                </div>
              </div>

              {/* Meal List */}
              {selectedMeals.length > 0 && (
                <div className="mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-semibold text-gray-800">Your Meal Plan</h2>
                    
                    {/* Meal Plan Actions */}
                    {!useLocalData && isSignedIn && (
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() => setShowSaveMealPlan(!showSaveMealPlan)}
                          className="flex items-center space-x-1 px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm"
                        >
                          <span>💾</span>
                          <span>Save Plan</span>
                        </button>
                        <button
                          onClick={() => {
                            setShowLoadMealPlan(!showLoadMealPlan);
                            if (!showLoadMealPlan) loadSavedMealPlans();
                          }}
                          disabled={isLoadingMealPlans}
                          className="flex items-center space-x-1 px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-gray-400 transition-colors text-sm"
                        >
                          <span>📂</span>
                          <span>{isLoadingMealPlans ? 'Loading...' : 'Load Plan'}</span>
                        </button>
                      </div>
                    )}
                  </div>

                  {/* Save Meal Plan Form */}
                  {showSaveMealPlan && !useLocalData && isSignedIn && (
                    <div className="bg-purple-50 p-4 rounded-lg mb-4 border border-purple-200">
                      <h3 className="font-medium text-gray-800 mb-3">Save Current Meal Plan</h3>
                      <div className="flex items-center space-x-3">
                        <input
                          type="text"
                          value={mealPlanName}
                          onChange={(e) => setMealPlanName(e.target.value)}
                          placeholder="Enter meal plan name..."
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        />
                        <button
                          onClick={saveMealPlan}
                          disabled={!mealPlanName.trim() || isLoadingMealPlans}
                          className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        >
                          {isLoadingMealPlans ? 'Saving...' : 'Save'}
                        </button>
                        <button
                          onClick={() => {
                            setShowSaveMealPlan(false);
                            setMealPlanName('');
                          }}
                          className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Load Meal Plan List */}
                  {showLoadMealPlan && !useLocalData && isSignedIn && (
                    <div className="bg-indigo-50 p-4 rounded-lg mb-4 border border-indigo-200">
                      <h3 className="font-medium text-gray-800 mb-3">Load Saved Meal Plan</h3>
                      {savedMealPlans.length > 0 ? (
                        <div className="space-y-2">
                          {savedMealPlans.map((plan, index) => (
                            <div key={index} className="flex items-center justify-between bg-white p-3 rounded-lg border">
                              <div className="flex-1">
                                <h4 className="font-medium text-gray-800">{plan.name}</h4>
                                <p className="text-sm text-gray-600">
                                  {plan.date} • {plan.mealCount} meals: {plan.meals.slice(0, 3).map(m => m.name).join(', ')}
                                  {plan.meals.length > 3 && ` + ${plan.meals.length - 3} more`}
                                </p>
                              </div>
                              <button
                                onClick={() => loadMealPlan(index)}
                                className="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors text-sm"
                              >
                                Load
                              </button>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="text-gray-600 text-center py-4">
                          {isLoadingMealPlans ? 'Loading saved meal plans...' : 'No saved meal plans found.'}
                        </p>
                      )}
                      <div className="mt-3">
                        <button
                          onClick={() => setShowLoadMealPlan(false)}
                          className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Meal Search Modal */}
                  {showMealSearch && (
                    <div className="bg-orange-50 p-4 rounded-lg mb-4 border border-orange-200">
                      <div className="flex items-center justify-between mb-3">
                        <h3 className="font-medium text-gray-800">
                          Search & Add Meal to Slot {selectedSlotIndex + 1}
                        </h3>
                        <button
                          onClick={() => {
                            setShowMealSearch(false);
                            setSelectedSlotIndex(-1);
                            setSearchQuery('');
                            setFilteredMeals([]);
                          }}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          ❌
                        </button>
                      </div>
                      
                      <div className="mb-3">
                        <input
                          type="text"
                          value={searchQuery}
                          onChange={(e) => handleSearchMeals(e.target.value)}
                          placeholder="Search for meals..."
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                        />
                      </div>
                      
                      <div className="max-h-64 overflow-y-auto space-y-2">
                        {filteredMeals.length > 0 ? (
                          filteredMeals.map((meal, index) => (
                            <div key={index} className="flex items-center justify-between bg-white p-3 rounded-lg border">
                              <div className="flex-1">
                                <h4 className="font-medium text-gray-800">{meal.name}</h4>
                                <p className="text-sm text-gray-600">
                                  {meal.ingredients && meal.ingredients.length > 0 
                                    ? `${meal.ingredients.length} ingredients`
                                    : 'No ingredients'
                                  }
                                </p>
                              </div>
                              <button
                                onClick={() => addMealToSlot(meal)}
                                className="px-3 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors text-sm"
                              >
                                Add to Slot
                              </button>
                            </div>
                          ))
                        ) : (
                          <p className="text-gray-600 text-center py-4">
                            {searchQuery.trim() === '' ? 'Enter a search term to find meals' : 'No meals found matching your search'}
                          </p>
                        )}
                      </div>
                    </div>
                  )}

                  <div className="space-y-3">
                    {selectedMeals.map((meal, index) => (
                      <div key={index} className="flex items-center justify-between bg-gray-50 p-4 rounded-lg border-2 border-transparent hover:border-orange-200 transition-colors">
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-1">
                            <span className="bg-orange-100 text-orange-800 text-xs font-medium px-2 py-1 rounded-full">
                              Slot {index + 1}
                            </span>
                            <h3 className="font-medium text-gray-800">{meal.name}</h3>
                          </div>
                          <p className="text-sm text-gray-600">
                            {meal.ingredients && meal.ingredients.length > 0 
                              ? (meal.ingredients.slice(0, 4).join(', ') + 
                                 (meal.ingredients.length > 4 ? ` + ${meal.ingredients.length - 4} more` : ''))
                              : 'No ingredients listed'
                            }
                          </p>
                        </div>
                        <div className="flex items-center space-x-2">
                          <button
                            onClick={() => openMealSearchForSlot(index)}
                            className="flex items-center space-x-1 px-3 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors text-sm"
                          >
                            <span>🔍</span>
                            <span>Change</span>
                          </button>
                          <button
                            onClick={() => replaceMeal(index)}
                            className="flex items-center space-x-1 px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors"
                          >
                            <span>🔄</span>
                            <span>Random</span>
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Generate Grocery List Button */}
              {selectedMeals.length > 0 && (
                <div className="mb-6">
                  {selectedMeals.some(meal => meal.ingredients && meal.ingredients.length > 0) ? (
                    <button
                      onClick={() => setShowGroceryList(!showGroceryList)}
                      className="flex items-center space-x-2 px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                    >
                      <span>🛒</span>
                      <span>{showGroceryList ? 'Hide' : 'Show'} Grocery List</span>
                    </button>
                  ) : (
                    <div className="bg-yellow-50 p-4 rounded-lg">
                      <p className="text-sm text-gray-700">
                        <strong>Note:</strong> Add ingredients to your meals to generate a grocery list!
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Enhanced Grocery List */}
              {showGroceryList && selectedMeals.length > 0 && (
                <div className="bg-green-50 p-6 rounded-lg">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-semibold text-gray-800">Enhanced Grocery List</h2>
                    
                    {/* Grocery List Actions */}
                    {!useLocalData && isSignedIn && (
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() => setShowSaveGroceryList(!showSaveGroceryList)}
                          className="flex items-center space-x-1 px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm"
                        >
                          <span>💾</span>
                          <span>Save List</span>
                        </button>
                        <button
                          onClick={() => {
                            setShowLoadGroceryList(!showLoadGroceryList);
                            if (!showLoadGroceryList) loadSavedGroceryLists();
                          }}
                          disabled={isLoadingGroceryLists}
                          className="flex items-center space-x-1 px-3 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 disabled:bg-gray-400 transition-colors text-sm"
                        >
                          <span>📋</span>
                          <span>{isLoadingGroceryLists ? 'Loading...' : 'Load List'}</span>
                        </button>
                      </div>
                    )}
                  </div>

                  {/* Save Grocery List Form */}
                  {showSaveGroceryList && !useLocalData && isSignedIn && (
                    <div className="bg-white p-4 rounded-lg mb-4 border border-green-200">
                      <h3 className="font-medium text-gray-800 mb-3">Save Current Grocery List</h3>
                      <div className="flex items-center space-x-3">
                        <input
                          type="text"
                          value={groceryListName}
                          onChange={(e) => setGroceryListName(e.target.value)}
                          placeholder="Enter grocery list name..."
                          className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                        />
                        <button
                          onClick={saveGroceryList}
                          disabled={!groceryListName.trim() || isLoadingGroceryLists}
                          className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                        >
                          {isLoadingGroceryLists ? 'Saving...' : 'Save'}
                        </button>
                        <button
                          onClick={() => {
                            setShowSaveGroceryList(false);
                            setGroceryListName('');
                          }}
                          className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Load Grocery List */}
                  {showLoadGroceryList && !useLocalData && isSignedIn && (
                    <div className="bg-white p-4 rounded-lg mb-4 border border-green-200">
                      <h3 className="font-medium text-gray-800 mb-3">Load Saved Grocery List</h3>
                      {savedGroceryLists.length > 0 ? (
                        <div className="space-y-2">
                          {savedGroceryLists.map((list, index) => (
                            <div key={index} className="flex items-center justify-between bg-green-50 p-3 rounded-lg border">
                              <div className="flex-1">
                                <h4 className="font-medium text-gray-800">{list.name}</h4>
                                <p className="text-sm text-gray-600">
                                  {list.date} • {list.itemCount} items
                                </p>
                              </div>
                              <button
                                onClick={() => loadGroceryList(index)}
                                className="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors text-sm"
                              >
                                Load
                              </button>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="text-gray-600 text-center py-4">
                          {isLoadingGroceryLists ? 'Loading saved grocery lists...' : 'No saved grocery lists found.'}
                        </p>
                      )}
                      <div className="mt-3">
                        <button
                          onClick={() => setShowLoadGroceryList(false)}
                          className="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Manual Item Addition */}
                  <div className="bg-white p-4 rounded-lg mb-4 border border-green-200">
                    <h3 className="font-medium text-gray-800 mb-3">Add Items Manually</h3>
                    <div className="flex items-center space-x-3">
                      <input
                        type="text"
                        value={newGroceryItem}
                        onChange={(e) => setNewGroceryItem(e.target.value)}
                        placeholder="Enter item name..."
                        className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                        onKeyPress={(e) => e.key === 'Enter' && addToGroceryList()}
                      />
                      <input
                        type="number"
                        min="1"
                        value={newGroceryQuantity}
                        onChange={(e) => setNewGroceryQuantity(parseInt(e.target.value) || 1)}
                        className="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                      />
                      <button
                        onClick={addToGroceryList}
                        disabled={!newGroceryItem.trim()}
                        className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                      >
                        Add
                      </button>
                    </div>
                  </div>

                  {/* Manual Grocery Items */}
                  {manualGroceryList.length > 0 && (
                    <div className="bg-white p-4 rounded-lg mb-4 border border-green-200">
                      <h3 className="font-medium text-gray-800 mb-3">Manual Items ({manualGroceryList.length})</h3>
                      <div className="space-y-2">
                        {manualGroceryList.map((item, index) => (
                          <div key={index} className="flex items-center justify-between bg-green-50 p-3 rounded-lg">
                            <span className="text-gray-700 capitalize flex-1">{item.name}</span>
                            <div className="flex items-center space-x-2">
                              <input
                                type="number"
                                min="1"
                                value={item.quantity}
                                onChange={(e) => updateGroceryItemQuantity(index, parseInt(e.target.value) || 1)}
                                className="w-16 px-2 py-1 border border-gray-300 rounded text-center text-sm"
                              />
                              <button
                                onClick={() => removeFromGroceryList(index)}
                                className="text-red-500 hover:bg-red-50 p-1 rounded"
                              >
                                ❌
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Combined Grocery List */}
                  <div className="bg-white p-4 rounded-lg border border-green-200">
                    <h3 className="font-medium text-gray-800 mb-3">Complete Grocery List</h3>
                    {generateEnhancedGroceryList().length > 0 ? (
                      <>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                          {generateEnhancedGroceryList().map((item, index) => (
                            <div key={index} className="flex items-center justify-between bg-gray-50 p-2 rounded border">
                              <span className="text-gray-700 capitalize">{item.name}</span>
                              {item.quantity > 1 && (
                                <span className="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full">
                                  x{item.quantity}
                                </span>
                              )}
                            </div>
                          ))}
                        </div>
                        <div className="mt-4 text-sm text-gray-600">
                          Total items: {generateEnhancedGroceryList().length}
                        </div>
                      </>
                    ) : (
                      <p className="text-gray-600">No ingredients found in selected meals and no manual items added. Add ingredients to meals or add items manually!</p>
                    )}
                  </div>
                </div>
              )}

              {/* Instructions */}
              <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                <h3 className="font-medium text-gray-800 mb-2">Meal Planner with Google Sheets OAuth2 Integration!</h3>
                <p className="text-sm text-gray-600 mb-2">
                  {useLocalData ? 
                    'Currently using local data with 113 historic meals. Enable Google Sheets integration above and sign in with your Google account to sync with the spreadsheet.' :
                    isSignedIn ? 
                      'Google Sheets integration is enabled and connected. Your meals will be saved to and loaded from the Google Sheet with full read/write access.' :
                      'Google Sheets integration is enabled. Sign in with your Google account above to connect with full access.'
                  }
                </p>
                <p className="text-sm text-gray-600">
                  <strong>Setup:</strong> Configure OAuth2 in Google Cloud Console and update the OAUTH_CLIENT_ID in the code. OAuth2 provides secure authentication and full read/write access to your Google Sheets.
                </p>
              </div>
            </div>
          );
        };

        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<MealPlanner />);
    </script>
</body>
</html>
